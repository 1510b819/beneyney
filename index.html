<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Beneyney â€” Firebase Trystero demo</title>
<style>
  :root{--bg:#0b0f14;--fg:#e7eef7;--muted:#93a1b3;--accent:#7dd3fc;--card:#111723}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:960px;margin:auto;padding:24px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between}
  header h1{font-size:20px;margin:0}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,button{border-radius:10px;border:1px solid #1f2937;background:#0f1623;color:var(--fg);padding:8px 10px}
  input{flex:1;min-width:180px}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#0ea5e9,#0369a1);border:0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  video{width:100%;height:160px;background:#000;border-radius:8px;outline:0}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0f172a;border:1px solid #243041;border-radius:999px}
  .hidden{display:none}
  .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:auto}
  .video-wrap{position:relative}
  .footer{opacity:.7;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Beneyney (Firebase)</h1>
    <span id="status" class="pill">idle</span>
  </header>

  <div class="card">
    <div class="row">
      <input id="room" placeholder="Room ID" />
      <button id="genRoom">Create Room</button>
      <button id="copyLink">Copy Join Link</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="join" class="primary">Join Room</button>
      <button id="leave" disabled>Leave</button>
      <button id="startCam">Start Camera</button>
      <button id="shareScreen">Share Screen</button>
      <button id="stopLocal" disabled>Stop Local</button>
      <button id="muteToggle" disabled>Mute</button>
    </div>
    <p class="hint" style="color:var(--muted)">Tip: Share the join link. On mobile a tap may be required to start remote audio.</p>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Your preview</h3>
    <div class="grid">
      <div class="video-wrap"><video id="self" muted playsinline autoplay></video></div>
    </div>
    <div class="row" style="margin-top:8px">
      <span id="selfNote" class="pill hidden">Streaming to room</span>
      <span id="noPeers" class="pill">Waiting for peersâ€¦</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Remote viewers</h3>
    <div id="peers" class="grid"></div>
    <p class="hint" style="color:var(--muted)">Each remote peer appears here. If audio doesn't play, ask them to tap the video once.</p>
  </div>

  <p class="footer">Built with <a href="https://github.com/dmotz/trystero" target="_blank" rel="noreferrer">Trystero</a> + Firebase.</p>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js'
import { joinRoom, selfId } from 'https://esm.run/trystero/firebase'

// ---- Your Firebase config ----
const firebaseConfig = {
  apiKey: "AIzaSyDhdEYo44LlhCwtOwMgqxu6caPHHdEscVk",
  authDomain: "beneyney-6b314.firebaseapp.com",
  databaseURL: "https://beneyney-6b314-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "beneyney-6b314",
  storageBucket: "beneyney-6b314.appspot.com",
  messagingSenderId: "885364596544",
  appId: "1:885364596544:web:dec245628bb143a1c3e4a5",
  measurementId: "G-2XC1GTX70X"
}

const app = initializeApp(firebaseConfig)
const db = getDatabase(app)



// --- UI setup ---
const $ = sel => document.querySelector(sel)
const status = $('#status')
const roomInput = $('#room')
const btnJoin = $('#join'), btnLeave = $('#leave'), btnStartCam = $('#startCam'),
      btnShareScreen = $('#shareScreen'), btnStopLocal = $('#stopLocal'),
      btnMute = $('#muteToggle'), btnCopy = $('#copyLink'), btnGen = $('#genRoom')
const selfVideo = $('#self'), peersDiv = $('#peers'), selfNote = $('#selfNote'), noPeers = $('#noPeers')

let room = null, selfStream = null, micMuted = false

function setStatus(txt){ status.textContent = txt }
function randId(){ return 'room-' + Math.random().toString(36).slice(2,8) }
function cleanRoomId(id){ return (id||'').trim().replace(/\s+/g,'-') }
function getRoomFromURL(){
  const u = new URL(window.location.href)
  return cleanRoomId(u.searchParams.get('room') || u.hash.replace(/^#/, '') || '')
}
function setURLRoom(r){
  const u = new URL(window.location.href)
  u.searchParams.set('room', r)
  history.replaceState(null, '', u.toString())
  localStorage.setItem('lastRoom', r)
}

btnGen.addEventListener('click', ()=>{ roomInput.value = randId(); setURLRoom(roomInput.value) })
btnCopy.addEventListener('click', async ()=>{
  if(!roomInput.value) return alert('Enter a room ID first')
  const link = `${location.origin}${location.pathname}?room=${encodeURIComponent(roomInput.value)}`
  await navigator.clipboard.writeText(link)
  btnCopy.textContent = 'Copied!'; setTimeout(()=>btnCopy.textContent='Copy Join Link', 1200)
})

btnJoin.addEventListener('click', join)
btnLeave.addEventListener('click', leave)
btnStartCam.addEventListener('click', startCamera)
btnShareScreen.addEventListener('click', shareScreen)
btnStopLocal.addEventListener('click', stopLocal)
btnMute.addEventListener('click', toggleMute)

roomInput.value = getRoomFromURL() || localStorage.getItem('lastRoom') || roomInput.value


if(roomInput.value) { join().catch(err => { console.error(err); setStatus('error'); }) }
// --- Core join ---
async function join(){
  const id = cleanRoomId(roomInput.value)
  if(!id) return alert('Pick a room ID')
  setURLRoom(id)
  setStatus('joiningâ€¦')

  room = joinRoom(db, id)

  room.onPeerJoin(pid => {
    noPeers.classList.add('hidden')
    toast(`ðŸ‘‹ ${pid} joined`)
  })
  room.onPeerLeave(pid => {
    toast(`ðŸšª ${pid} left`)
    const el = document.getElementById(`peer-${pid}`)
    if(el) el.remove()
    if(!peersDiv.children.length) noPeers.classList.remove('hidden')
  })

  room.onPeerStream((stream, pid) => {
    let vid = document.getElementById(`peer-${pid}`)
    if(!vid){
      const wrap = document.createElement('div')
      wrap.className = 'video-wrap'
      vid = document.createElement('video')
      vid.id = `peer-${pid}`
      vid.autoplay = true
      vid.playsInline = true
      vid.controls = true
      vid.muted = false
      vid.style.cursor = 'pointer'
      vid.addEventListener('click', ()=> { vid.muted = false; tryPlayWithFallback(vid) })
      wrap.appendChild(vid)
      peersDiv.appendChild(wrap)
    }
    vid.srcObject = stream
    tryPlayWithFallback(vid)
  })

  btnJoin.disabled = true; btnLeave.disabled = false
  btnStartCam.disabled = false; btnShareScreen.disabled = false
  btnMute.disabled = false; btnMute.textContent = 'Mute'
  setStatus(`in room Â· you: ${selfId.slice(0,6)}`)
}

async function leave(){
  try{ room && room.leave() }catch{}
  room = null
  setStatus('idle')
  btnJoin.disabled = false; btnLeave.disabled = true
  btnStartCam.disabled = true; btnShareScreen.disabled = true
  btnStopLocal.disabled = true; btnMute.disabled = true
  peersDiv.innerHTML = ''
  noPeers.classList.remove('hidden')
  stopLocal()
}

async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:true })
    await startLocalStream(s)
  } catch(err){ alert('Could not access camera/mic: '+ err.message) }
}

async function shareScreen(){
  try{
    const s = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true })
    try{
      const mic = await navigator.mediaDevices.getUserMedia({ audio:true })
      mic.getAudioTracks().forEach(t=> s.addTrack(t))
    }catch{}
    await startLocalStream(s)
  } catch(err){ alert('Screen share failed: ' + err.message) }
}

async function startLocalStream(stream){
  if(selfStream){ selfStream.getTracks().forEach(t=> t.stop()) }
  selfStream = stream
  selfVideo.srcObject = stream
  selfNote.classList.remove('hidden')
  btnStopLocal.disabled = false

  if(!room) await join()
  room.addStream(stream)
  room.onPeerJoin(pid => room.addStream(stream, pid))

  stream.getTracks().forEach(track=> track.addEventListener('ended', stopLocal))
}

function stopLocal(){
  if(selfStream){ selfStream.getTracks().forEach(t=> t.stop()); selfStream=null }
  selfVideo.srcObject = null
  selfNote.classList.add('hidden')
  btnStopLocal.disabled = true
}

function toggleMute(){
  if(!selfStream) return
  micMuted = !micMuted
  selfStream.getAudioTracks().forEach(t=> t.enabled = !micMuted)
  btnMute.textContent = micMuted ? 'Unmute' : 'Mute'
}

function toast(msg){
  const el = document.createElement('div')
  el.textContent = msg
  el.style.position='fixed';el.style.right='16px';el.style.bottom='16px';el.style.padding='10px 12px';el.style.borderRadius='12px';el.style.background='#0f172a';el.style.border='1px solid #243041';el.style.color='white';el.style.opacity='0.95';
  document.body.appendChild(el); setTimeout(()=>el.remove(), 2200)
}

function tryPlayWithFallback(vid){
  vid.play().catch(()=> {
    let overlay = vid.parentElement.querySelector('.play-overlay')
    if(overlay) return
    overlay = document.createElement('div')
    overlay.className = 'play-overlay'
    const btn = document.createElement('button')
    btn.textContent = 'Tap to play'
    btn.style.padding = '8px 12px'
    btn.style.borderRadius = '8px'
    btn.onclick = ()=> { vid.play().catch(()=>{}); overlay.remove() }
    overlay.appendChild(btn)
    vid.parentElement.appendChild(overlay)
  })
}


</script>
</body>
</html>
